generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Patient {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String
  calComId  String?  @unique // Cal.com attendee ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  appointments  Appointment[]
  conversations Conversation[]

  @@index([phone])
  @@index([email])
}

model Appointment {
  id              String            @id @default(cuid())
  patientId       String
  patient         Patient           @relation(fields: [patientId], references: [id])
  calComBookingId String?           @unique // Cal.com booking UID
  scheduledAt     DateTime          // When the consultation is
  status          AppointmentStatus @default(SCHEDULED)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  messages ScheduledMessage[]

  @@index([status])
  @@index([scheduledAt])
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED    // Patient confirmed (e.g. via voice call press-1)
  COMPLETED    // Consult happened — triggers post-consult flow
  NO_SHOW      // No-show detected — triggers recovery
  CANCELLED    // Patient cancelled
  RESCHEDULED
}

model ScheduledMessage {
  id            String        @id @default(cuid())
  appointmentId String
  appointment   Appointment   @relation(fields: [appointmentId], references: [id])
  jobId         String?       // BullMQ job ID — used to cancel scheduled jobs
  type          MessageType
  channel       Channel
  status        MessageStatus @default(PENDING)
  scheduledFor  DateTime      // When to send
  sentAt        DateTime?
  content       String?       // Stored after send for audit trail
  error         String?
  createdAt     DateTime      @default(now())

  @@index([appointmentId])
  @@index([status, scheduledFor])
}

enum MessageType {
  // Section 1.1 — Immediately after scheduling
  CONFIRMATION_SMS
  CHATBOT_INTRO_SMS
  CONFIRMATION_EMAIL

  // Section 1.2 — Pre-consult reminder
  PRE_CONSULT_REMINDER_SMS

  // Section 1.3 — Day-of
  DAY_OF_VOICE_CALL
  TWO_HOUR_REMINDER_SMS
  TWO_HOUR_REMINDER_EMAIL
  TEN_MIN_REMINDER_SMS

  // Section 2.1 — Post-consult
  POST_CONSULT_THANK_YOU_SMS
  POST_CONSULT_SUMMARY_EMAIL
  POST_CONSULT_CHATBOT_SMS

  // Section 3 — No-show recovery
  NO_SHOW_INITIAL_SMS
  NO_SHOW_INITIAL_EMAIL
  NO_SHOW_VOICE_CALL
  NO_SHOW_NEXT_DAY_SMS
  NO_SHOW_NEXT_DAY_EMAIL
  NO_SHOW_CHATBOT_SMS
  NO_SHOW_ESCALATION
}

enum Channel {
  SMS
  EMAIL
  VOICE
  CHATBOT
  INTERNAL // For escalation notifications
}

enum MessageStatus {
  PENDING
  QUEUED     // Handed to BullMQ
  SENT
  FAILED
  CANCELLED  // Cancelled because status changed (e.g. no-show flow cancelled on completion)
}

model Conversation {
  id        String   @id @default(cuid())
  patientId String
  patient   Patient  @relation(fields: [patientId], references: [id])
  context   String   // e.g. "pre_consult", "post_consult", "no_show_recovery"
  messages  ConversationMessage[]
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId, active])
}

model ConversationMessage {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  role           String       // "assistant" (Dr. Patel) or "user" (patient)
  content        String
  createdAt      DateTime     @default(now())
}
